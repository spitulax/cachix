#!/usr/bin/env bash

# TODO: invoke helper script via `nix run`

set -euo pipefail

command -v nom >/dev/null
NOM=$?

_nix () {
    nix --experimental-features 'nix-command flakes' $@
}

decolor () {
    sed -e 's/\x1b\[[0-9;]*m//g'
}

paths () {
    _nix path-info --json result/ | jq -r '.[].references.[]'
}

build () {
    echo -e '\033[1mBuilding packages...'
    if [ $NOM -eq 0 ]; then
        _nix build .#all --log-format internal-json -v --accept-flake-config |& nom --json
    else
        _nix build .#all --accept-flake-config
    fi
}

listpkgs () {
    local list=()
    for path in $(paths); do
        local env=$(_nix derivation show $path | jq -r '.[].env')
        local name=$(echo -n $env | jq -r 'if .pname == null then .name else .pname end')
        local version=$(echo -n $env | jq -r '.version')
        list+=($(echo -n "$name\"$version"))
    done
    IFS=$'\n' list=($(sort <<< "${list[*]}"))
    for pkg in ${list[@]}; do
        local name=$(echo $pkg | sed -r 's/^(.*)".*$/\1/')
        local version=$(echo $pkg | sed -r 's/^.*"//')
        echo -e "- \033[1m$name\033[0m: \033[2m$version\033[0m"
    done
}

listpkgsName () {
    listpkgs | sed -r 's/^- (.*): .*$/\1/' | decolor
}

push () {
    echo -e '\033[1mPushing packages...'
    cachix push spitulax `paths`
}

upinput () {
    echo -e '\033[1mUpdating flake inputs...'
    _nix flake update --accept-flake-config
}

# TODO: add package counter
# TODO: include excluded packages but mark them as uncached and outdated
uplist () {
    echo "<!--- This list was auto-generated by ./helper.sh. DO NOT edit this file manually. -->" > pkgs.md
    echo >> pkgs.md
    echo '<h2 align="center">List of Packages</h2>' >> pkgs.md
    echo >> pkgs.md
    echo '_(The latest version available in the nix store)_' >> pkgs.md
    echo >> pkgs.md
    while IFS= read -r line; do
        echo $line | decolor >> pkgs.md
    done <<< "$(listpkgs)"
}

upscript () {
    DRV=$(_nix build .#update-scripts --accept-flake-config --json | jq -r '.[].outputs.out')
    for x in $(find -L "$DRV/" -type f -executable); do
        DIRNAME=$(basename "$x")
        echo -e "\033[1mUpdating pkgs/${DIRNAME}...\033[0m"
        $x > "$(dirname "$0")/pkgs/${DIRNAME}/pkg.json"
    done
}

commitup () {
    IFS=$'\n'
    DIFF=($(git diff -U0 --cached HEAD pkgs.md | grep '^[+-]' | grep -Ev '^(--- a/|\+\+\+ b/)'))
    for x in ${DIFF[@]}; do
        if [ "${x:0:1}" = "-" ]; then
            NAME=$(echo "${x:3}" | sed -r 's/^(.*):.*$/\1/')
            OLDVER=$(echo "${x:3}" | sed -r 's/^.*: (.*)$/\1/')
            NEWDIFF=$(echo "${DIFF[*]}" | grep -F "$NAME" | tail -n1)
            NEWVER=$(echo "${NEWDIFF:3}" | sed -r 's/^.*: (.*)$/\1/')
            PKGS+=($(echo -e "${NAME}\t${OLDVER}\t${NEWVER}"))
        fi
    done

    MSG="update packages"
    MSG+=$'\n'
    for x in ${PKGS[@]}; do
        MSG+=$'\n'
        MSG+=$(echo "$x" | sed -r 's/^(.*)\t(.*)\t(.*)$/\1: \2 -> \3/')
    done
    git commit -m "$MSG"
}

usage () {
    echo "build"
    echo "commitup"
    echo "listpkgs"
    echo "pushinput"
    echo "pushpkgs"
    echo "upall"
    echo "upinput"
    echo "uplist"
    echo "uppkgs"
    echo "upscript"
}

[ $# -ne 1 ] && usage && exit 1

case "$1" in
"upinput")
    upinput
    ;;

"build")
    build
    ;;

"pushinput")
    echo -e '\033[1mPushing inputs to cachix...'
    _nix flake archive --accept-flake-config --json \
        | jq -r '.path,(.inputs|to_entries[].value.path)' \
        | cachix push spitulax
    ;;

"pushpkgs")
    push
    ;;

"uplist")
    uplist
    ;;

"upscript")
    upscript
    ;;

"uppkgs")
    upscript && build && push && uplist
    ;;

"upall")
    upinput && upscript && build && push && uplist
    ;;

"listpkgs")
    listpkgs
    ;;

"commitup")
    commitup
    ;;

*)
    usage
    exit 1
    ;;
esac
